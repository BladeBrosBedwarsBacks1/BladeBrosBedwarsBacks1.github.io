function getRandomInt(min,max){min=Math.ceil(min);max=Math.floor(max);return Math.floor(Math.random()*(max-min+1))+min;}function generateWaitQuestion(){const num1=getRandomInt(1,10);const num2=getRandomInt(1,10);const operationInt=getRandomInt(1,4);let operationSymbol='';let answer=0;switch(operationInt){case 1:operationSymbol='+';answer=num1+num2;break;case 2:operationSymbol='-';answer=num1-num2;break;case 3:operationSymbol='*';answer=num1*num2;break;case 4:const product=num1*num2;answer=num1;num1=product;break;}sessionStorage.setItem('waitAnswer',answer);const waitQuestionText=document.getElementById('wait-question-text');if(waitQuestionText){waitQuestionText.textContent=`What is ${num1} ${operationSymbol} ${num2}?`;}document.getElementById('feedback-message').textContent='';}function submitWaitAnswer(){const expectedAnswer=sessionStorage.getItem('waitAnswer');const userInput=document.getElementById('wait-answer-input').value;const feedbackMessage=document.getElementById('feedback-message');if(userInput==expectedAnswer){feedbackMessage.textContent="Correct!";feedbackMessage.style.color="green";generateWaitQuestion();/* Moves to new question AFTER showing feedback */}else{feedbackMessage.textContent="Wrong, the answer was "+expectedAnswer;feedbackMessage.style.color="red";generateWaitQuestion();/* Moves to new question AFTER showing feedback */}}function getQueryParameter(name){const urlParams=new URLSearchParams(window.location.search);return urlParams.get(name);}async function login(userId){sessionStorage.setItem('currentUserId',userId);const loginSection=document.getElementById('login-section');if(loginSection)loginSection.classList.add('hidden');const loginOverlay=document.getElementById('login-overlay');if(loginOverlay)loginOverlay.classList.add('hidden');const mainContent=document.getElementById('main-content');if(mainContent)mainContent.classList.remove('hidden');if(window.location.pathname.includes('/learn/home/index.html')||window.location.pathname.includes('/learn/home/')){await fetchUserData(userId);}}async function fetchUserData(userId){const response=await fetch(`/api/user/${userId}`);if(response.ok){const user=await response.json();const usernameDisplay=document.getElementById('username-display');if(usernameDisplay)usernameDisplay.textContent=`User ${userId.substring(0,5)}...`;displayWeaknesses(user.weaknesses);}else{console.error('Failed to fetch user data');displayWeaknesses(null);}}function displayWeaknesses(weaknesses){const weaknessesList=document.getElementById('weaknesses-display');if(!weaknessesList)return;weaknessesList.innerHTML='';if(weaknesses&&Object.keys(weaknesses).length>0){for(const subject in weaknesses){for(const topic in weaknesses[subject]){const data=weaknesses[subject][topic];const li=document.createElement('li');li.textContent=`${subject.toUpperCase()}: ${topic} (Correct: ${data.correct}, Incorrect: ${data.incorrect})`;weaknessesList.appendChild(li);}}}else{weaknessesList.innerHTML='<li>You have no recorded weaknesses yet.</li>';}}async function getQuestion(subject){const userId=sessionStorage.getItem('currentUserId');if(!userId)return logout();const response=await fetch(`/api/question/${subject}?userId=${userId}`);if(response.ok){const questionData=await response.json();const questionArea=document.getElementById('question-area');if(!questionArea)return;document.getElementById('question-text').textContent=`Question for ${subject}: ${questionData.q}`;sessionStorage.setItem('currentAnswer',questionData.a);sessionStorage.setItem('currentTopic',questionData.topic);sessionStorage.setItem('currentSubject',subject);questionArea.classList.remove('hidden');}else{alert('Failed to fetch question.');}}async function submitAnswer(){const userId=sessionStorage.getItem('currentUserId');const expectedAnswer=sessionStorage.getItem('currentAnswer');const topic=sessionStorage.getItem('currentTopic');const subject=sessionStorage.getItem('currentSubject');const answerInput=document.getElementById('answer-input');const userAnswer=answerInput.value;const isCorrect=userAnswer.toLowerCase()===expectedAnswer.toLowerCase().replace(/\$/g,'');await fetch(`/api/submit-answer`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,subject,topic,isCorrect})});alert(isCorrect?'Correct!':`Incorrect. The answer was "${expectedAnswer}".`);answerInput.value='';document.getElementById('question-area').classList.add('hidden');await fetchUserData(userId);}function logout(){sessionStorage.removeItem('currentUserId');const loginSection=document.getElementById('login-section');if(loginSection)loginSection.classList.remove('hidden');const loginOverlay=document.getElementById('login-overlay');if(loginOverlay)loginOverlay.classList.remove('hidden');const mainContent=document.getElementById('main-content');if(mainContent)mainContent.classList.add('hidden');if(!window.location.pathname.includes('/learn/home/index.html')&&!window.location.pathname.includes('/learn/home/')){window.location.href='/learn/home';}}document.addEventListener('DOMContentLoaded',(event)=>{const loginStatus=getQueryParameter('login');const storedUserId=sessionStorage.getItem('currentUserId');const loginSection=document.getElementById('login-section');if(loginSection)loginSection.classList.add('hidden');const loginOverlay=document.getElementById('login-overlay');if(loginOverlay)loginOverlay.classList.add('hidden');const mainContent=document.getElementById('main-content');if(mainContent)mainContent.classList.add('hidden');if(loginStatus==='200'){const newUserId='authenticated-user-id';login(newUserId);window.history.replaceState({},document.title,window.location.pathname);}else if(storedUserId){login(storedUserId);}else{logout();}});
